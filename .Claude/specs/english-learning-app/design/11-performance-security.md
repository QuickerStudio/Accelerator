# 性能与安全

## 性能优化

### 1. LLM推理优化

**挑战**: 1.5B参数模型在移动设备上推理速度需要优化

**优化策略**:
- **模型量化**: 使用Q4_K_M量化减少模型大小和推理时间（从FP16的3GB降至Q4_K_M的900MB）
- **ARM优化**: 利用kotlinllamacpp的ARM原生优化（i8mm, dotprod指令）
- **上下文管理**: 限制上下文长度为2048 tokens，避免内存溢出
- **异步推理**: 在后台线程执行推理，避免阻塞UI
- **推理超时**: 设置30秒超时限制，超时后取消推理
- **流式输出**: 使用流式生成，实时显示生成的文本

**性能目标**:
- 单次推理时间 < 3秒（生成50 tokens）
- 内存占用 < 1.5GB
- 首次加载时间 < 15秒

### 2. 语音处理优化

**挑战**: 实时语音识别和合成的延迟

**优化策略**:
- **流式识别**: 使用Whisper的流式模式，边录音边转录
- **音频压缩**: 使用Opus编码压缩音频数据
- **预加载TTS**: 预先生成常用短语的音频缓存
- **VAD（语音活动检测）**: 只处理包含语音的音频段，跳过静音

**性能目标**:
- 语音识别延迟 < 2秒
- TTS播放延迟 < 1秒
- 音频文件大小 < 100KB/分钟

### 3. 数据库查询优化

**挑战**: 大量单词和对话记录的查询性能

**优化策略**:
- **索引优化**: 在常用查询字段上创建索引（learningDate, status, conversationId）
- **分页加载**: 使用Paging 3库实现分页加载历史记录
- **查询缓存**: 缓存今日单词列表，避免重复查询
- **批量操作**: 使用事务批量插入/更新数据

**性能目标**:
- 单词列表查询 < 100ms
- 对话历史加载 < 200ms
- 数据库写入 < 50ms

### 4. UI渲染优化

**挑战**: 复杂UI和动画可能导致卡顿

**优化策略**:
- **LazyColumn**: 使用懒加载列表避免一次性渲染所有项
- **remember**: 缓存计算结果避免重复计算
- **derivedStateOf**: 优化状态派生逻辑
- **图片优化**: 使用Coil库异步加载和缓存图片
- **动画优化**: 使用硬件加速和合理的动画时长

**性能目标**:
- 帧率 >= 60 FPS
- 页面切换延迟 < 300ms
- 内存占用 < 500MB

### 5. 存储优化

**挑战**: 模型文件和音频数据占用大量存储空间

**优化策略**:
- **按需下载**: 首次安装只包含核心功能，模型文件按需下载
- **音频压缩**: 使用Opus或AAC压缩音频
- **定期清理**: 自动删除30天前的对话音频
- **外部存储**: 允许用户将数据移至SD卡

**存储目标**:
- 应用安装包 < 50MB
- 模型文件 < 1GB（Q4_K_M量化后）
- 用户数据 < 500MB（不含音频）

---

## 安全考虑

### 1. 数据隐私

**威胁**: 用户的学习数据、对话记录、作文内容泄露

**防护措施**:
- **本地存储**: 所有数据存储在设备本地，不上传到云端
- **数据加密**: 使用Android Keystore加密敏感数据（用户进度、对话记录）
- **权限最小化**: 只请求必要权限（麦克风、存储）
- **数据导出**: 提供加密的数据导出功能

### 2. 模型安全

**威胁**: 模型文件被篡改或替换

**防护措施**:
- **文件完整性校验**: 使用SHA-256校验模型文件完整性
- **签名验证**: 验证模型文件的数字签名
- **安全下载**: 使用HTTPS下载模型文件
- **沙箱隔离**: 模型推理在隔离环境中执行

### 3. 输入验证

**威胁**: 恶意输入导致应用崩溃或异常行为

**防护措施**:
- **长度限制**: 限制文本输入长度（单词 < 50字符，作文 < 10000字符）
- **字符过滤**: 过滤特殊字符和控制字符
- **SQL注入防护**: 使用参数化查询避免SQL注入
- **异常处理**: 捕获所有异常并优雅降级

### 4. 资源保护

**威胁**: 恶意使用导致设备资源耗尽

**防护措施**:
- **推理限流**: 限制每分钟最多10次LLM推理请求
- **内存监控**: 监控内存使用，超过阈值时释放缓存
- **电池优化**: 避免在低电量时执行重型推理
- **后台限制**: 应用在后台时停止所有AI推理
