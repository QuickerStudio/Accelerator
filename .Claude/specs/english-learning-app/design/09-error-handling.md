# 错误处理

## 错误场景 1: 模型加载失败

### 条件
应用启动时无法加载LLM模型文件（文件损坏、内存不足、不支持的设备）

### 响应
- 捕获异常并记录详细错误日志
- 向用户显示友好错误提示："AI功能暂时不可用，请检查存储空间或重新安装应用"
- 禁用依赖AI的功能（口语训练、语法检查）
- 允许用户继续使用单词学习等基础功能

### 恢复
- 提供"重新加载模型"按钮
- 在后台尝试重新下载模型文件
- 检查设备兼容性并提供降级方案（使用更小的模型）

---

## 错误场景 2: 语音识别失败

### 条件
麦克风权限被拒绝、音频质量过低、环境噪音过大、Whisper模型推理失败

### 响应
- 检测权限状态，如未授权则引导用户到设置页面
- 显示音频质量指示器，提示用户改善录音环境
- 如果转录置信度过低（< 0.3），提示用户重新录制
- 提供文本输入作为备选方案

### 恢复
- 允许用户手动输入文本代替语音
- 保存失败的音频文件用于后续分析
- 自动调整音频预处理参数（降噪、增益）

---

## 错误场景 3: 语法检查超时

### 条件
LLM推理时间过长（> 30秒）、设备性能不足、文本过长

### 响应
- 设置推理超时限制（30秒）
- 显示进度指示器和"正在分析..."提示
- 超时后取消推理并显示错误："文本分析超时，请尝试缩短文本或稍后重试"
- 保存用户输入，避免数据丢失

### 恢复
- 将长文本分段处理（每段 < 500词）
- 提供"快速检查"模式（只检查基础语法）
- 允许用户手动触发重试

---

## 错误场景 4: 数据库操作失败

### 条件
磁盘空间不足、数据库文件损坏、并发写入冲突

### 响应
- 使用事务确保数据一致性
- 捕获SQLiteException并记录详细错误
- 向用户显示："保存失败，请检查存储空间"
- 尝试将数据缓存到内存

### 恢复
- 实现自动重试机制（最多3次，指数退避）
- 提供数据库修复工具
- 导出数据到外部存储作为备份

---

## 错误场景 5: TTS播放失败

### 条件
音频输出设备不可用、TTS引擎未安装、文本包含不支持的字符

### 响应
- 检测TTS引擎可用性，如未安装则引导用户下载
- 过滤或替换不支持的字符
- 显示文本内容作为备选（即使无法播放语音）
- 记录失败原因到日志

### 恢复
- 提供多个TTS引擎选项（Google TTS、系统TTS）
- 允许用户调整语速和音调
- 缓存常用单词的音频文件
